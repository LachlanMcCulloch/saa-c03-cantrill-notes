# 1.6 AWS EC2

## 1.6.1 Virtualization Basics

- Traditional: Kernel in system runs in Privileged Mode and can operate with
  Hardware
- Emulated Virtualization (Software Virtualization)
  - System runs Host Operating System (or Hypervisor)
  - Each application would run in a Virtual Machine
    - VM would have its own OS, Linux, Windows, etc
    - Virtual allocation of resources, emulated hardware
  - Guest operating systems perform Binary translation to hypervisor for
    privileged calls
    - Incredibly slow performance
- Para-Virtualization
  - Small subset of OS which allow modification
    - Instead of privileged calls, these are re-programmed to be a special user
      call called Hypercalls which call the hypervisor directly.
- Hardware Assisted Virtualization
  - Hardware is aware of virtualization
    - e.g. Calls to CPU go straight to CPU and are re-routed to Hypervisor
    - IO devices like disk and network cards appear as physical devices to VM,
      however are routed back to physical software calls in the hypervisor
- SR-IOV (Single Root IO Virtualization)
  - High level: Allows a network (or any other addon card) to present itself as
    several mini cards. As far as hardware is concerned, these are separate
    cards
    - Presented to the guest VMs as real cards and no translation needed between
      hypervisor
    - In EC2, this is called Enhanced Networking

## 1.6.2 EC2 Architecture and Resilience

- EC2 Instances are virtual machines (OS+Resources)
- Run on EC2 Hosts
  - Shared Hosts
    - Shared (but sandboxed) with other customers
  - Dedicated Hosts
    - Own dedicated host
- EC2 Host runs in 1AZ
  - AZ Fails, Host Fails, Instance fails

### What's EC2 Good For?

- Traditional OS+Application Compute
- Long-running Compute
- Server Style Applications (Traditional OS waiting for traffic)
  - either burst or steady-state load
- Monolithic application stacks
- Migrated application workloads or disaster recovery

## 1.6.3 EC2 Instance Types

- Choosing instance types affects:
  - Raw CPU, Memory, Local Storage Capacity & Type
  - Resource Ratios (CPU:RAM, etc etc)
  - Storage and Data Network Bandwidth
  - System Architecture / Vendor (arm, intel, etc)
  - Additional Features and Capabilities
    - GPUS
    - FPGA - programmable CPU
- Categories:
  - General Purpose (Default)
    - Diverse workloads, equal resource ratio
  - Computed optimised
    - Media Processing, HPC, Scientific Modelling, gaming, ML
  - Memory optimised
    - Processing large in-memory datasets, some db workloads
  - Accelerated computing
    - Hardware GPU, FPGA
  - Storage optimised
    - Sequential and Random IO
      - Scale-out transactional db, data warehousing, elasticsearch, analytics
        workloads.

### Decoding EC2 Types

- e.g. `R5dn.8xlarge`
  - `R` - instance family
  - `5` - instance generation
  - `dn` - additional capabilities
    - `a` - amd cpu
    - `d` - nvme storage
    - `n` - network optimised
    - `e` - extra capacity (RAM, storage)
  - `8xlarge` - instance size

## 1.6.4 EC2 Storage

- Key Terms
  - Direct (local) attached storage
    - Storage on the EC2 Host
  - Network attached storage
    - Volumes delivered over the network (EBS)
  - Ephemeral storage
    - temporary storage
  - Persistent storage
    - Permanent storage
    - Lives on past the lifetime of instance
  - Block storage
    - Volume presented to the OS as a collection of blocks
    - no stucture provided. Mountable, Bootable
  - File storage
    - Presented as a file share
    - Has structure. Mountable, not Bootable
  - Object storage
    - Collection of objects
    - flat
    - Not mountable, not bootable
    - e.g. S3

- Storage Performance
  - IO (block) Size
    - Size of the blocks of size of data writing to storage
      - 16K, 64K, 1M, etc
  - IOPS
    - Number of IO operations it can achieve in a second
  - Throughput
    - IO Size * IOPS = Throughput
      - `16KB` Block size with `100IOPS` = `1.6MB/s`

## 1.6.5 Elastic Block Store (EBS)

- Allow block storage - was disk allocations
  - can be encrypted using KMS
  - instances see as block device and can create file systems on device (ext3/4,
    xfs)
- Storage is provisioned in **ONE AZ** (Resilient in that AZ)
- EBS attaches to \*one EC2 instance (or other service) over a storage network
  - \* Some storage types allow multi-attach to connect to multiple instances
    - Used for clusters
    - Has to be managed by application code to avoid overwriting data
- Can be detached and reattached, not lifecycle linked to on instance
  (persistent)
- Snapshot created into S3. Volumes can be created from snapshot to migrate
  between AZs
- Provision different types, sizes, performance profile etc
- Billed based on GB-month (and in some cases performance)

## 1.6.6 EBS Volume Types

- IO Credit == 16KB
- IO Credit bucket

- General Purpose SSD - GP2
  - Volumes can as small as 1GB, or as large as 16TB
  - When not using volume much, not consuming many credits
    - periods of high disk load push volume hard, consumes more credits
      - system boots, backups, heavy db work
    - when credit bucket exhausted, performance drops to baseline (3IOPS per GB?)
  - Bucket refills at minimum 100 IO credits per second (regardless of volume
    size)
  - GP2 bursts up to 3000 IOPS
  - Volumes larger than 1TB achieve baseline that is higher than burst
    - Credit system is not used and always achieve baseline
    - Up to maximum for gp2 of 16K IO credits per second (baseline)
  - Great for boot volumes, low-latency interactive apps, dev & test

- GP3
  - Does away with credit bucket
  - Starts with 3,000 IOPS
  - Transfers 125 MiB/s
  - GP3 is cheaper (~20%) vs GP2 at base price
    - Pick if using 3000IOPS
    - Extra cost up to 16K IOPS (or 1,000 MiB/s)
    - 4x Faster Max throughput vs GP2
      - 1,000MiB/s vs 250MiB/s

- Provisioned IOPS SSD (io1/2)
  - IOPS can be adjusted independently of size
  - Consistent low latency & jitter
  - up to 64,000 IOPS per volume (4x GP2/3)
  - Up to 256,000 IOPS per volume (Block Express)
  - Up to 1,000 MB/s throughput
  - Up to 4,000 MB/s throughput (Block Express)
  - 4GB-16TB (io1/2)
  - 4GB-64TB (BlockExpress)
  - io1 50IOPS/GB (Max)
  - io2 500IOPS/GB (Max)
  - BlockExpress 1000IOPS/GB (Max)
  - Only most modern and largest instances can provide these provisioned
    maximums
  - io2 has better efficiency scaling over io1 (lower total GB to achieve higher
    IOPS)
  - Per instance performance
    - io1 - 260,000 IOPS & 7,500MB/s
    - io2 - 160,000 IOPS & 4,750MB/s
    - io2 Block Express - 260,000 IOPS & 7,500MB/s
  - High performance, latency sensitive workloads. I/O-intensive NoSQL
    & relational databases
    - Smaller volumes but need super high performance

- Hard Disk Drive (HDD)-based
  - st1: Throughput Optimised
    - less expensive than ssd based, good for large volumes of data
    - sequential access (written or read in sequential pattern)
      - Throughput and economy is more important than IOPS or performance
    - 125GB - 16TB
    - Max 500IOPS (where 1IO is 1MB) -> Max 500MB/s
    - Similar bucket architecture to GP2
      - 40MB/s/TB Base
      - 250MB/s/TB Burst
    - Big data, data warehouses, log processing
  - sc1: Cold HDD
    - even cheaper
    - Max 250 IOPS (1MB)
    - Max 250MB/s
    - 12MB/s/TB Base
    - 80MB/s/TB Burst
    - 125GB - 16TB
    - Store lots of data and don't care about performance
    - Lowest cost HDD volume designed for less frequently accessed workloads
    - Colder data requiring fewer scans per day

## 1.6.7 Instance Store Volumes

- Provide block store devices.
- Physically connected to one EC2 host.
- Instances on host can access them
- Highest storage performance in AWS
- Included in instance price
- Can only be **attached at launch**.
- Instances when start/stopped or migrated can be moved to different host and
  lose access to the ephemeral (instance store) they were pointed to.
- Instance Store Volumes
  - D3 = 4.6GB/s throughput
  - I3 = 16GB/s of sequential throughput
  - More IOPS and throughput vs EBS

## 1.6.8 Choosing between Instance Store & EBS

- Persistent storage?
  - ALWAYS EBS
- Resilience?
  - ALWAYS EBS
- Storage isolated from instance lifecycle?
  - ALWAYS EBS
- Resilience w/ App In-built replication?
  - Depends on scenario
- High performance needs
  - Depends on performance as IS can greatly outperform EBS
- Super high performance?
  - Instance Store
- Cost?
  - Instance store (often included in instance pricing)
- Questions related to where EBS is needed
  - Cheap
    - Use ST1 or SC1
  - Throughput or streaming
    - ST1
  - Boot
    - Not ST1 or SC1
  - GP2/3 - up to 16,000 IOPS
  - IO1/2 - up to 64,000 IOPS (256,000 - larger instance types)
  - RAID0 + EBS up to 260,000 IOPS (io1/2-BE/GP2/2)
    - Requires large instance to reach max throughput
  - More than 260,000 IOPS
    Instance Store can achieve but need to be able to tolerate non-persistent
    data
  
## 1.6.9 EBS Snapshots

- Efficient way of backing up EBS volumes to S3.
  - Incremental volume copies
  - First snapshot is a full copy of data of the volume
  - Future snaps are incremental
- Snapshots can be used to move EBS volumes between AZs and copy to another
  region
- Volume Performance
  - New EBS Volume = full performance immediately
  - Snapshots restore lazily which are fetched gradually
    - Requested blocks are fetched immediately
    - Force a read of all the data immediately, byte by byte

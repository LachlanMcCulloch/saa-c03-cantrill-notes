# 1.5 AWS VPC

## 1.5.1 VPC Sizing and Structure

- VPC Considerations
  - Deciding in advance the structure of the CIDR ranges is critical
    - Not easy to change later and painful when not done right
  - What size should the VPC be
  - Are there any networks we cannot use?
    - Other networks such as: VPCs, Cloud, On-Prem, Partners & Vendors
  - Try to predict the future
  - VPC Structure: Tiers  & Resiliency (AZ)
  - VPC minimum is /28 (16 ips), maximum /16 (65,536 ips)
  - Avoid common ranges
    - 10.0.x.x, 10.1.x.x, 10.10.x.x
    - cantrill recommends starting at 10.16
  - Reserve 2+ networks per region being used per account

### VPC Sizing

| **VPC Size** | **Netmask** | **Subnet Size** | **Hosts/Subnet** | **Subnets/VPC** | Total IPs |
|--------------|-------------|-----------------|------------------|-----------------|-----------|
| Micro        | /24         | /27             | 27               | 8               | 216       |
| Small        | /21         | /24             | 251              | 8               | 2008      |
| Medium       | /19         | /22             | 1019             | 8               | 8152      |
| Large        | /18         | /21             | 2043             | 8               | 16344     |
| Extra Large  | /16         | /20             | 4091             | 16              | 65456     |

### VPC Sizing

- Cantrill recommends 4 (3VPCs + 1 Spare)
  - Following layers for VPC Structure:
    - WEB
    - APP
    - DB
    - Spare

## 1.5.2 Custom VPCs

- Regional service so allows all AZs within the region
- Custom VPC is an isolated network
- Nothing IN or OUT without explicit configuration.
- Flexible configuration
  - Simple or multi-tier
- Hybrid networking - Other clouds and/or on-prem
- Custom VPC offers Default or Dedicated Tenancy
  - Default allows flexibility to choose per-resource for dedicated tenancy
  - Custom VPC Dedicated Tenancy is locked in
- Custom VPCs allow IPv4 Private CIDR Blocks and Public IPs
  - Each VPC is provisioned 1 Primary Private IPv4 CIDR Block
  - Allows min /28 (16 IPs) and Max /16 (65,536 IPs)
  - Allows optional secondary IPv4 Blocks
- Has optional single assigned IPv6 /56 CIDR Block

### DNS in a VPC

- Provided by R53
- VPC DNS is Base IP +2 address (10.0.0.0/16, then 10.0.0.2)
- `enableDnsHostnames` - gives Instances DNS Names
- `enableDnsSupport` - enables DNS resolution in VPC

## 1.5.3 VPC Subnets

- AZ Resilient
- A subnetwork of a VPC that runs within a particular AZ
- 1 Subnet can only be in 1 AZ
- 1 AZ can have 0 or many AZs
- IPv4 CIDR is a subnet of the VPC CIDR
- Cannot overlap with other subnets
- Optional IPv6 CIDR (/64 subset of the /56 VPC - space for 256)
- Subnets can communicate with other subnets in the VPC
- Every VPC has a DHCP Options Set
  - Auto assigns public IPv4 with configuration
  - Auto assigns public IPv6 with configuration

### Subnet IP Addressing

- Reserved IP Addresses (5 in total). e.g for 10.16.16.0/20
  - Network (10.16.16.0)
  - Network +1 (10.16.16.1) - VPC Router
  - Network +2 (10.16.16.2) - Reserved (DNS\*)
  - Network +3 (10.16.16.3) - Reserved Future Use
  - Broadcast Address (10.16.31.255) Last IP in subnet

## 1.5.4 VPC Routing and Internet Gateway

- VPC Router
  - Every VPC has one, highly available
  - Moves traffic from somewhere to somewhere else
  - Every subnet has routing address (`'network+1'`)
  - Routes traffic between subnets
  - Controller by 'route tables' where each subnet has one
  - Has main route table - subnet default
    - Each subnet by default associated with main RT
    - Each subnet can be changed to be assoc with new RT
  - Higher cidr prefix ranges = higher priority in route table

- Internet Gateway (IGW)
  - Region resilient gateway attached to a VPC
    - One IGW per region (NOT AZ)
      1VPC = 0 or 1IGW, 1IGW = 0 or 1VPC
  - IGW runs from border of VPC and AWS Public Zone
    - Gateways traffic between VPC and Internet or AWS Public Zone
      (S3..SQS..SNS..etc)
  - Managed - AWS Handles performance
  - Using an IGW
    1. Create IGW
    1. Attach IGW to VPC
    1. Create custom RT
    1. Associate RT
    1. Default Routes => IGW (0.0.0.0/0 & ::/0)
    1. Subnet allocates Public IPv4

- IPv4 Addresses with a IGW
  - IPv4 Instance, when connected to IGW creates a record in the IGW.
  - IGW is effectively behaving as a one-to-one NAT for its public IPv4 address.
  - **NOTE**: In the OS of private instance, it is **NOT** configured with the
    public ip address!

- Bastion Host / Jumpbox
  - An instance in a public subnet that handles incoming management connections
  - Management point or entry point for private VPCs.
  - Often the only way IN to a VPC in a highly secured VPCs.

## 1.5.5 Stateful vs Stateless Firewalls

- Stateless: Has no concept of state and handles IN/OUT traffic independtently
- Stateful: Intelligent enough to identify the request nd response components of
  a connection as being related

## 1.5.6 Network Access Control Lists (NACL)

- NACLs are stateless.
- NACLs filter traffic crossing the subnet boundary INBOUND or OUTBOUND
- Connections within a subnet are not impaced by NACLs
- NACL rules are processed in order, lowest rule number first.
- Once a match occurs, processing stops.
- * is an implicit DENY if nothing else matches
- Default NACL inside of a VPC is default ALLOW.
- Custom NACL default behaviour is all traffice DENIED.
- Really good for explicit blocks of traffic - bad actor IP addresses, etc.
- NACL only allow IPs/CIDR, Ports and protocols - no logical resources.
- NACL cannot be assigned to AWS resources - only subnets
- Used together with Security Groups to add explicit DENY (Bad IPs/Nets)
- Each subnet can have one NACL (Default or Custom)
- A NACL can be associated with MANY Subnets
